# PyQt5 A股房地产资产查询界面

## 概述

本项目为A股非经营性房地产资产查询系统添加了PyQt5桌面图形界面，提供了直观易用的查询操作体验。

## 功能特性

### 🏢 五大功能块

1. **指标选择区**
   - 下拉框选择资产负债表科目（18种财务指标）
   - 手动输入框支持自定义科目
   - 仅包含资产负债表相关科目

2. **时点选择区**
   - 4个时点选择控件（QDateEdit）
   - 最多选择4个非空值
   - 允许留空（查询所有时点）
   - UI层基本校验与提示

3. **查询条件区**
   - 股票代码输入（支持多个，逗号分隔）
   - 股票名称输入（支持模糊搜索）
   - 市场选择下拉（全部/沪市/深市/北市）
   - 查询按钮和重置按钮

4. **数据展示区**
   - QTableView + QStandardItemModel显示结果
   - 动态列匹配所选时点
   - 异步查询不阻塞主线程
   - QProgressBar进度反馈

5. **导出功能**
   - 导出Excel按钮（无结果时禁用）
   - QFileDialog用户选择保存路径
   - 成功后弹窗提示

### 🎯 技术特点

- **多线程查询**: 使用QThread后台执行查询
- **异常处理**: 网络失败/无数据/输入错误的对话框提示
- **入口暴露**: 支持`python -m ui.real_estate_query_app`启动
- **无依赖降级**: 无PyQt5环境时提供命令行模式

## 项目结构

```
ui/
├── __init__.py                 # 模块初始化文件
├── real_estate_query_app.py   # 主PyQt5界面文件
├── data_query_service.py      # 数据查询服务层
run_ui.py                      # 启动脚本
test_ui.py                     # 测试脚本和示例数据
```

## 安装和运行

### 1. 安装依赖

```bash
# 安装PyQt5
pip install PyQt5

# 或者使用系统包管理器
sudo apt install python3-pyqt5

# 安装项目依赖
pip install -r requirements.txt
```

### 2. 启动方式

#### GUI模式（推荐）
```bash
# 方式1: 直接运行
python -m ui.real_estate_query_app

# 方式2: 使用启动脚本
python run_ui.py
```

#### 命令行模式（无PyQt5环境）
```bash
python run_ui.py
# 系统会自动检测PyQt5并降级到命令行模式
```

### 3. 使用测试数据

```bash
# 生成测试数据和功能验证
python test_ui.py
```

## 使用指南

### 基本操作流程

1. **启动系统**
   ```bash
   python run_ui.py
   ```

2. **选择财务指标**
   - 从下拉框选择指标（如：总资产、营业收入等）
   - 或在手动输入框输入自定义科目

3. **设置查询时点**
   - 选择1-4个年份（如：2022, 2023, 2024）
   - 可留空查询所有可用年份

4. **设置查询条件**
   - 股票代码：输入多个代码用逗号分隔，留空表示全部
   - 股票名称：支持模糊搜索，多个名称用逗号分隔
   - 市场：选择全部/沪市/深市/北市

5. **执行查询**
   - 点击"查询"按钮
   - 系统使用后台线程执行，不阻塞界面
   - 可通过进度条查看查询进度

6. **导出结果**
   - 查询完成后点击"导出Excel"按钮
   - 选择保存路径和文件名
   - 系统自动格式化Excel文件

### 界面功能详解

#### 财务指标选择
- **下拉框**: 18种预定义资产负债表科目
  - 资产类：总资产、流动资产合计、非流动资产合计
  - 负债类：负债合计、流动负债合计、非流动负债合计
  - 权益类：所有者权益合计
  - 损益类：营业收入、营业成本、净利润等
- **手动输入**: 支持输入自定义科目名称

#### 时点选择
- **4个日期控件**: 支持选择具体日期或仅年份
- **智能限制**: 最多选择4个非空值
- **灵活查询**: 允许留空以查询所有年份数据

#### 股票筛选
- **代码筛选**: 支持多个股票代码，逗号分隔
- **名称搜索**: 支持模糊匹配，包含关键词即可
- **市场过滤**: 按交易所市场分类筛选

#### 结果展示
- **表格显示**: 使用QTableView展示查询结果
- **动态列**: 根据选择的时点动态调整列结构
- **工具提示**: 鼠标悬停显示完整数据

## 技术实现

### 服务层设计

```python
# 数据查询服务类
class DataQueryService:
    - 加载资产负债表科目列表
    - 执行数据查询和过滤
    - 处理Excel导出功能
    - 数据库连接管理
```

### 异步查询实现

```python
# 查询工作线程
class QueryWorker(QThread):
    progress = pyqtSignal(int)    # 进度更新
    finished = pyqtSignal(pd.DataFrame)  # 查询完成
    error = pyqtSignal(str)       # 错误处理
```

### UI组件架构

- **QMainWindow**: 主窗口容器
- **QGroupBox**: 功能区域分组
- **QFormLayout/QGridLayout**: 表单布局
- **QTableView**: 结果数据展示
- **QThread**: 后台查询执行

## 数据库设计

### 核心表结构

```sql
-- 股票基础信息表
stocks (
    code TEXT PRIMARY KEY,    -- 股票代码
    name TEXT,                -- 股票名称
    market TEXT,              -- 市场(SH/SZ/BJ)
    created_at TIMESTAMP
)

-- 行业分类表
industries (
    code TEXT,                -- 股票代码
    l1 TEXT,                  -- 申万一级行业
    l2 TEXT,                  -- 申万二级行业
    l3 TEXT                   -- 申万三级行业
)

-- 财务数据表
financial_data (
    code TEXT,                -- 股票代码
    year TEXT,                -- 年份
    non_op_real_estate REAL,  -- 非经营性房地产资产
    data_source TEXT          -- 数据来源
)
```

## 测试和验证

### 功能测试

```bash
# 完整功能测试
python test_ui.py
```

测试内容包括：
- ✅ 18种财务指标加载
- ✅ 按市场查询（沪市/深市/北市）
- ✅ 按股票代码查询
- ✅ 按年份查询
- ✅ Excel导出功能
- ✅ 示例数据创建

### 性能验证

- **并发查询**: QThread多线程不阻塞主界面
- **内存管理**: 合理的数据加载和释放
- **错误处理**: 网络异常、数据异常的用户友好提示

## 故障排除

### 常见问题

1. **PyQt5导入失败**
   ```bash
   # 解决方案
   pip install PyQt5
   # 或使用命令行模式
   python run_ui.py
   ```

2. **数据库文件不存在**
   ```bash
   # 运行测试脚本创建示例数据
   python test_ui.py
   ```

3. **查询无结果**
   - 检查筛选条件是否过于严格
   - 确认数据库中有对应数据
   - 尝试放宽搜索条件

4. **Excel导出失败**
   - 检查文件写入权限
   - 确保磁盘空间充足
   - 验证文件路径是否有效

## 扩展说明

### 后续优化方向

1. **字段扩展**: 支持更多资产负债表科目
2. **图表展示**: 添加数据可视化图表
3. **数据更新**: 集成实时数据更新机制
4. **模板保存**: 支持查询条件模板保存
5. **批量操作**: 支持批量导出多份报表

### 架构优势

- **松耦合设计**: UI与数据层分离
- **可扩展性**: 易于添加新功能模块
- **用户体验**: 异步操作不阻塞界面
- **容错性**: 完善的异常处理机制

## 许可证

本项目为A股房地产资产查询系统的一部分，遵循原项目的许可证条款。