# 动态Excel导出功能 - 快速指南

## 🎯 功能概述

为 `excel_exporter.py` 新增的动态Excel导出功能，专为UI查询结果导出设计。

## ✨ 主要特性

- ✅ **动态列生成**：根据选择的时点自动生成列（0~4个时点）
- ✅ **自动格式化**：数值列自动应用千分位格式，缺失值红色标识
- ✅ **元数据追溯**：自动生成"查询条件"sheet记录查询信息
- ✅ **简洁API**：一行代码完成导出
- ✅ **完善测试**：8个单元测试覆盖各种场景

## 🚀 快速开始

### 最简单的用法

```python
from excel_exporter import ExcelReportGenerator

# 准备数据
data = [
    {
        'code': '000001',
        'name': '平安银行',
        'market': '深交所主板',
        'industry': '银行',
        'value_2023-12-31': 1200000.00,
        'value_2024-06-30': 1250000.25,
    }
]

# 一行代码导出
result = ExcelReportGenerator.export_dynamic_query_results(
    data=data,
    indicator_name='投资性房地产',
    periods=['2023-12-31', '2024-06-30'],
    filters={'市场': '主板'}
)

print(f"导出成功: {result}")
```

## 📊 输出示例

### Sheet 1: 查询结果
```
┌─────────┬──────────┬──────────┬──────┬───────────────────────┬───────────────────────┐
│ 股票代码 │ 公司名称  │   市场    │ 行业 │ 2023-12-31_投资性房地产 │ 2024-06-30_投资性房地产 │
├─────────┼──────────┼──────────┼──────┼───────────────────────┼───────────────────────┤
│ 000001  │ 平安银行  │ 深交所主板 │ 银行 │      1,200,000.00     │      1,250,000.25     │
└─────────┴──────────┴──────────┴──────┴───────────────────────┴───────────────────────┘
```

### Sheet 2: 查询条件
```
┌──────────┬──────────────────────┐
│   项目    │          值          │
├──────────┼──────────────────────┤
│ 生成时间  │ 2024-12-16 10:30:45  │
│ 指标名称  │ 投资性房地产          │
│ 时点数量  │ 2                    │
│ 时点列表  │ 2023-12-31, 2024-06-30│
│ 市场     │ 主板                  │
└──────────┴──────────────────────┘
```

## 📝 数据格式要求

数据字典中必须包含以下字段：
- `code`: 股票代码
- `name`: 公司名称
- `market`: 市场
- `industry`: 行业
- `value_{period}`: 各时点的指标值（如 `value_2023-12-31`）

## 🧪 测试

```bash
# 运行单元测试
python test_excel_dynamic_export.py

# 运行示例演示
python example_dynamic_export.py
```

## 📚 完整文档

- **API文档**：`EXCEL_DYNAMIC_EXPORT_API.md`
- **实现总结**：`DYNAMIC_EXPORT_IMPLEMENTATION.md`
- **测试代码**：`test_excel_dynamic_export.py`
- **示例代码**：`example_dynamic_export.py`

## 💡 使用场景

1. **UI查询结果导出** - 用户在Web界面查询后导出Excel
2. **多时点对比分析** - 导出1~4个时点的数据进行对比
3. **定期报告生成** - 定时生成标准格式的数据报告
4. **数据追溯审计** - 通过元数据sheet追溯查询条件

## ⚙️ 支持的时点数量

- **0个时点** → 仅基本信息（4列）
- **1个时点** → 基本信息 + 1个指标列（5列）
- **2个时点** → 基本信息 + 2个指标列（6列）
- **3个时点** → 基本信息 + 3个指标列（7列）
- **4个时点** → 基本信息 + 4个指标列（8列）
- **>4个时点** → 全部导出（但会记录警告）

## 🎨 格式化特性

- **表头**：蓝色背景，粗体，居中
- **文本列**：左对齐
- **数值列**：右对齐，千分位格式（#,##0.00）
- **缺失值**：红色背景标识
- **所有单元格**：带边框

## ⚠️ 注意事项

1. **数据键名格式**：时点值的键名必须是 `value_{日期}`
2. **文件覆盖**：同名文件会被覆盖
3. **线程安全**：不支持并发导出
4. **文件名安全**：特殊字符会被自动替换

## 🔄 返回值

- **成功** → 返回文件路径字符串
- **失败** → 返回 `None`

## 📞 错误处理

所有错误都会自动捕获并记录日志：
- 数据为空 → 返回None，记录WARNING
- 参数错误 → 返回None，记录ERROR
- 文件生成失败 → 返回None，记录ERROR + 堆栈

## 🚦 状态

✅ **已完成并测试通过**
- 代码实现：100%
- 测试覆盖：8/8 通过
- 文档完整：100%
- 性能验证：通过

---

**版本**: 1.0.0  
**创建日期**: 2024-12-16  
**Python要求**: 3.6+  
**依赖**: xlsxwriter
