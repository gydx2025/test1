# A股非经营性房地产资产数据收集器

这是一个Python脚本，用于自动获取中国A股全部上市公司2023年末和2024年末的非经营性房地产资产金额数据。

## 功能特性

### 数据收集
- ✅ **完整股票列表获取**：支持分页获取全部5496+只A股股票
- ✅ **多数据源支持**：东方财富网 + 备用数据源
- ✅ **智能降级处理**：网络异常时自动切换到演示模式
- ✅ **2023年末和2024年末非经营性房地产资产数据**
- ✅ **包含行业分类和公司基本信息**
- ✅ **智能重试和错误处理机制**
- ✅ **实时进度显示和剩余时间估算**

### 数据处理
- ✅ 数据清洗（处理缺失值、异常值）
- ✅ 数据去重（基于股票代码）
- ✅ 数据验证（确保数据合理性）
- ✅ 数据格式统一

### 输出功能
- ✅ Excel文件输出，支持多个工作表
- ✅ 原始数据、处理后数据、统计信息
- ✅ 数据格式化和美化
- ✅ 支持文件命名自定义

## 安装依赖

```bash
pip install -r requirements.txt
```

**依赖包包括**：
- 数据处理：pandas, numpy, openpyxl, xlsxwriter
- 网络请求：requests, beautifulsoup4, lxml
- 数据源：tushare, akshare
- 进度显示：tqdm
- **图形界面**：PyQt5 (>=5.15.0), PyQt5-sip (>=12.11.0)

## 使用方法

### 方式1：图形界面（推荐）🖥️

使用 PyQt5 图形界面，提供直观的可视化操作：

```bash
# 方法 1：使用启动脚本（推荐）
chmod +x run_gui.sh
./run_gui.sh

# 方法 2：直接运行
python3 astock_real_estate_collector_gui.py
```

#### GUI 主要功能

图形界面提供以下五项核心功能：

1. **数据采集配置** 📊
   - 选择数据采集模式（测试/完整/自定义数量）
   - 配置数据源优先级
   - 设置并发和重试参数

2. **高级查询参数** 🔍
   - **时点选择**：选择数据时间点（2023年末、2024年末或两者）
   - **指标校验**：启用/禁用数据质量校验、范围检查
   - **股票过滤**：按股票代码、名称、市场（主板/创业板/科创板等）筛选
   - **市场过滤**：选择沪市/深市/北交所等特定市场
   - **行业过滤**：按申万一级/二级/三级行业分类筛选

3. **实时进度监控** 📈
   - 采集进度条和百分比显示
   - 实时日志输出窗口
   - 成功/失败数量统计
   - 预计剩余时间显示

4. **数据预览与验证** ✅
   - 采集数据实时预览表格
   - 数据质量评分显示（A+ ~ D 评级）
   - 缺失数据高亮提示
   - 异常数据警告

5. **灵活导出选项** 💾
   - 选择导出格式（Excel/CSV/JSON）
   - 自定义导出字段
   - 导出文件命名规则配置
   - 一键导出或分表导出

#### GUI 与 CLI 的关系

- **GUI**：适合交互式使用，提供可视化配置和实时反馈，推荐日常使用
- **CLI**：适合自动化脚本、定时任务和批处理，适合集成到其他系统

两种方式共享相同的核心数据采集引擎，数据质量和功能完全一致。

### 方式2：命令行界面（CLI）

适合自动化场景和脚本集成：

```bash
# 方法 1：直接运行
python3 astock_real_estate_collector.py

# 方法 2：使用启动脚本
chmod +x run_collector.sh
./run_collector.sh
```

### 方式3：在脚本中调用

```python
from astock_real_estate_collector import AStockRealEstateDataCollector

# 创建收集器
collector = AStockRealEstateDataCollector()

# 执行数据收集（处理全部股票）
output_file = collector.run()

# 或者限制处理数量（用于测试）
output_file = collector.run(max_stocks=100)  # 只处理前100只股票
```

## 输出文件

脚本会生成Excel文件，包含以下工作表：

### 1. 原始数据
- 包含从各个数据源获取的原始数据
- 字段：股票代码、股票名称、2023年数据、2024年数据、行业、市场

### 2. 处理后数据
- 经过清洗和验证的数据
- 字段：
  - 股票代码
  - 股票名称
  - 2023年末非经营性房地产资产(元)
  - 2024年末非经营性房地产资产(元)
  - 资产变化(元)
  - 变化率(%)
  - 行业分类
  - 市场

### 3. 数据统计
- 总股票数量
- 有非经营性房地产资产的公司数量统计
- 资产总额统计
- 平均资产统计

## 导出操作步骤

### GUI 方式导出

1. **完成数据采集**：等待采集进度达到 100%
2. **预览数据**：在"数据预览"标签页检查数据质量
3. **配置导出选项**：
   - 选择导出格式（Excel/CSV/JSON）
   - 勾选需要导出的字段
   - 设置文件命名规则（默认：A股非经营性房地产资产_YYYYMMDD_HHMMSS）
4. **执行导出**：
   - 点击"导出为Excel"按钮（推荐）
   - 或点击"导出为CSV"（便于数据库导入）
5. **确认结果**：弹出对话框显示导出文件路径

### CLI 方式导出

CLI 模式会在数据采集完成后自动生成 Excel 文件，无需额外操作。

### 导出注意事项

⚠️ **重要提示**：

1. **文件路径**：确保输出目录有写入权限，默认保存在当前工作目录
2. **文件占用**：导出前请关闭已打开的同名 Excel 文件，否则导出会失败
3. **数据完整性**：
   - 导出前检查数据质量评分，建议评分 ≥ B（80分）再导出
   - 如评分较低，考虑重新采集或使用"数据补全"功能
4. **大文件处理**：
   - 完整数据（5400+股票）导出的 Excel 文件约 5-15MB
   - 如遇 Excel 打开缓慢，可使用 CSV 格式或分批导出
5. **时间戳**：文件名包含时间戳，避免覆盖历史数据
6. **编码格式**：
   - Excel：自动处理编码，推荐用于数据分析
   - CSV：UTF-8 编码，适合数据库导入和编程处理
7. **数据备份**：重要数据建议同时导出 Excel 和 CSV 两种格式作为备份

## 配置说明

### 数据源配置
脚本按照以下优先级尝试获取数据：
1. 东方财富网 (eastmoney.com)
2. 新浪财经 (sina.com)  
3. 巨潮资讯网 (cninfo.com.cn)

### 请求配置
- 请求超时：15-30秒
- 请求间隔：0.5秒（避免频率限制）
- User-Agent：浏览器标识

### 错误处理
- 网络请求失败自动重试下一个数据源
- 单个股票获取失败不影响整体流程
- 详细的日志记录便于问题排查

## 数据清洗规则

1. **数据验证**
   - 排除无股票代码或名称的记录
   - 数值类型转换和范围检查

2. **去重处理**
   - 基于股票代码去重
   - 保留首次出现的记录

3. **数据清洗**
   - 负值置为0
   - 缺失值填充为0
   - 数值精度处理

## 日志级别

- INFO：程序运行状态
- WARNING：非致命错误
- ERROR：严重错误

## 测试模式

生产使用：
```python
collector.run()  # 处理全部股票
```

测试使用：
```python
collector.run(max_stocks=50)  # 只处理50只股票进行测试
```

## 故障排除

### 常见问题

1. **依赖包安装失败**
   ```bash
   pip install --upgrade pip
   pip install -r requirements.txt
   ```

2. **网络连接问题**
   - 检查网络连接
   - 确认防火墙设置
   - 可能需要配置代理

3. **数据获取失败**
   - 检查数据源网站状态
   - 可能需要更新User-Agent
   - 调整请求频率

4. **Excel文件生成失败**
   - 确认有文件写入权限
   - 检查磁盘空间
   - 关闭可能打开的Excel文件

### 调试模式

修改脚本中的日志级别：
```python
logging.basicConfig(level=logging.DEBUG)
```

## 扩展功能

### 添加新数据源

1. 在`AStockRealEstateDataCollector`类中添加新方法
2. 更新`search_real_estate_data`方法中的数据源列表
3. 实现相应的数据获取逻辑

### 自定义数据字段

修改`search_real_estate_data`方法的返回值结构，更新Excel导出的字段定义。

### 数据验证规则

在`clean_and_validate_data`方法中添加新的验证规则。

## 注意事项

1. **法律合规**：确保数据使用符合相关法律法规
2. **请求频率**：注意请求频率限制，避免对目标网站造成压力
3. **数据准确性**：建议对获取的数据进行人工验证
4. **备份数据**：建议对重要的数据结果进行备份

## 版本信息

- 版本：1.0.0
- Python版本要求：3.7+
- 支持的操作系统：Windows, macOS, Linux