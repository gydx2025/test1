# A股非经营性房地产资产查询系统

这是一个完整的Python系统，包含数据收集器和PyQt5 UI应用，用于自动获取和查询中国A股全部上市公司的非经营性房地产资产及财务数据。

## 系统架构

混合架构（缓存 + 实时采集）：
- **本地缓存**：SQLite数据库存储股票基础数据（代码、名称、上市时间、申万行业分类等）
- **实时采集**：动态获取科目数据（资产负债表等），支持多源循环补齐
- **UI应用**：PyQt5界面，支持参数选择和实时进度显示
- **Excel导出**：两个Sheet（查询结果 + 元数据）

## 功能特性

### 数据收集
- ✅ **完整股票列表获取**：支持分页获取全部5496+只A股股票
- ✅ **多数据源支持**：东方财富网 + 备用数据源
- ✅ **智能降级处理**：网络异常时自动切换到演示模式
- ✅ **2023年末和2024年末非经营性房地产资产数据**
- ✅ **包含行业分类和公司基本信息**
- ✅ **智能重试和错误处理机制**
- ✅ **实时进度显示和剩余时间估算**

### 数据处理
- ✅ 数据清洗（处理缺失值、异常值）
- ✅ 数据去重（基于股票代码）
- ✅ 数据验证（确保数据合理性）
- ✅ 数据格式统一

### 输出功能
- ✅ Excel文件输出，支持多个工作表
- ✅ 原始数据、处理后数据、统计信息
- ✅ 数据格式化和美化
- ✅ 支持文件命名自定义

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 方式一：PyQt5 UI应用（推荐）

#### 启动UI应用
```bash
python run_ui.py
```

#### 功能说明
1. **启动时初始化缓存**
   - 首次运行：建立SQLite缓存库（30-60秒）
   - 非首次同一天：直接加载缓存（立即可用）
   - 新的一天：增量更新（<10秒）

2. **参数选择**
   - 科目选择：最多选3个（资产负债表科目）
   - 时点选择：最多选4个（财报期）
   - 行业过滤：选择一个或全行业
   - 股票筛选：支持代码和名称模糊搜索
   - 市场过滤：全部/沪市/深市/北市

3. **查询流程**
   - 点击"查询"按钮
   - 显示实时采集进度
   - 采集完成显示成功/失败统计

4. **结果导出**
   - 点击"导出"按钮
   - Sheet1：完整查询结果（所有列和行）
   - Sheet2：元数据（时点、科目、条件、生成时间等）

### 方式二：命令行模式

如果未安装PyQt5，系统自动启动命令行模式：
```bash
python run_ui.py
```

### 方式三：直接调用采集器

#### 基本使用（处理全部股票）
```bash
python3 astock_real_estate_collector.py
```

#### 使用启动脚本
```bash
chmod +x run_collector.sh
./run_collector.sh
```

#### 在脚本中调用
```python
from astock_real_estate_collector import AStockRealEstateDataCollector

# 创建收集器
collector = AStockRealEstateDataCollector()

# 执行数据收集（处理全部股票）
output_file = collector.run()

# 或者限制处理数量（用于测试）
output_file = collector.run(max_stocks=100)  # 只处理前100只股票
```

## 本地缓存系统

### 缓存库结构
位置：`local_cache/stock_base_data.db`

包含两个主要表：
1. **stocks表**（股票基础信息）
   - code: 股票代码
   - name: 股票名称
   - market: 市场（沪/深/北）
   - list_date: 上市时间
   - update_time: 更新时间
   - data_source: 数据来源

2. **industries表**（行业分类）
   - code: 股票代码
   - shenwan_level1: 申万一级行业
   - shenwan_level2: 申万二级行业
   - shenwan_level3: 申万三级行业
   - general_industry: 通用行业
   - data_source: 数据来源

### 缓存初始化流程
1. 检查缓存库是否存在
2. 若不存在，调用采集器获取5400+只股票
3. 获取行业分类（三级申万分类）
4. 建立SQLite缓存库
5. 记录初始化时间戳至`cache_meta.json`

### 每日更新流程
1. 检查`cache_meta.json`中的`last_update_date`
2. 若今天未更新过：
   - 从采集器获取最新数据
   - 与缓存比对（新增、删除、变更）
   - 执行增量更新
   - 记录更新完成
3. 若今天已更新，直接使用缓存

### 查询性能
- 基础数据加载：<100ms
- 缓存初始化：30-60s（首次）
- 缓存更新：<10s（每日）
- 科目数据采集：主要耗时来自实时查询

## 输出文件

### Excel导出格式

#### Sheet1: 查询结果
包含列：
- 股票代码
- 股票名称
- 上市时间
- 申万一级/二级/三级行业
- 通用行业
- 市场
- 科目数据（按时点×科目动态生成）

数据格式：
- 代码、名称：文本
- 日期：日期格式
- 行业：文本
- 金额：数字格式（整数，无小数）

#### Sheet2: 元数据
包含内容：
- 查询时点：所选的所有财报期
- 选定科目：所选科目的中文名称
- 行业筛选：选中的行业或"全行业"
- 股票筛选：筛选条件或"无"
- 市场筛选："全部"或特定市场
- 生成时间：导出的时间戳
- 结果统计：成功和失败数量

### 原始Excel文件格式

脚本会生成Excel文件，包含以下工作表：

### 1. 原始数据
- 包含从各个数据源获取的原始数据
- 字段：股票代码、股票名称、2023年数据、2024年数据、行业、市场

### 2. 处理后数据
- 经过清洗和验证的数据
- 字段：
  - 股票代码
  - 股票名称
  - 2023年末非经营性房地产资产(元)
  - 2024年末非经营性房地产资产(元)
  - 资产变化(元)
  - 变化率(%)
  - 行业分类
  - 市场

### 3. 数据统计
- 总股票数量
- 有非经营性房地产资产的公司数量统计
- 资产总额统计
- 平均资产统计

## 配置说明

### 数据源配置
脚本按照以下优先级尝试获取数据：
1. 东方财富网 (eastmoney.com)
2. 新浪财经 (sina.com)  
3. 巨潮资讯网 (cninfo.com.cn)

### 请求配置
- 请求超时：15-30秒
- 请求间隔：0.5秒（避免频率限制）
- User-Agent：浏览器标识

### 错误处理
- 网络请求失败自动重试下一个数据源
- 单个股票获取失败不影响整体流程
- 详细的日志记录便于问题排查

## 数据清洗规则

1. **数据验证**
   - 排除无股票代码或名称的记录
   - 数值类型转换和范围检查

2. **去重处理**
   - 基于股票代码去重
   - 保留首次出现的记录

3. **数据清洗**
   - 负值置为0
   - 缺失值填充为0
   - 数值精度处理

## 日志级别

- INFO：程序运行状态
- WARNING：非致命错误
- ERROR：严重错误

## 测试模式

生产使用：
```python
collector.run()  # 处理全部股票
```

测试使用：
```python
collector.run(max_stocks=50)  # 只处理50只股票进行测试
```

## 故障排除

### 常见问题

1. **依赖包安装失败**
   ```bash
   pip install --upgrade pip
   pip install -r requirements.txt
   ```

2. **网络连接问题**
   - 检查网络连接
   - 确认防火墙设置
   - 可能需要配置代理

3. **数据获取失败**
   - 检查数据源网站状态
   - 可能需要更新User-Agent
   - 调整请求频率

4. **Excel文件生成失败**
   - 确认有文件写入权限
   - 检查磁盘空间
   - 关闭可能打开的Excel文件

### 调试模式

修改脚本中的日志级别：
```python
logging.basicConfig(level=logging.DEBUG)
```

## 扩展功能

### 添加新数据源

1. 在`AStockRealEstateDataCollector`类中添加新方法
2. 更新`search_real_estate_data`方法中的数据源列表
3. 实现相应的数据获取逻辑

### 自定义数据字段

修改`search_real_estate_data`方法的返回值结构，更新Excel导出的字段定义。

### 数据验证规则

在`clean_and_validate_data`方法中添加新的验证规则。

## 注意事项

1. **法律合规**：确保数据使用符合相关法律法规
2. **请求频率**：注意请求频率限制，避免对目标网站造成压力
3. **数据准确性**：建议对获取的数据进行人工验证
4. **备份数据**：建议对重要的数据结果进行备份

## 版本信息

- 版本：1.0.0
- Python版本要求：3.7+
- 支持的操作系统：Windows, macOS, Linux